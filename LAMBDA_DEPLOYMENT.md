# Lambda Deployment Guide

This guide shows you how to deploy the Lambda function that fetches trade data from Limitless Exchange API and uploads it to S3.

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBridge Rule   â”‚  Triggers every 5 minutes
â”‚  (CloudWatch Events)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lambda Function    â”‚
â”‚  - Fetch positions  â”‚â”€â”€â”€â”€â”€â”€â”
â”‚  - Fetch history    â”‚      â”‚
â”‚  - Calculate stats  â”‚      â”‚
â”‚  - Format data      â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
           â”‚                 â”‚
           â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  S3 Bucket   â”‚   â”‚  Limitless API  â”‚
    â”‚              â”‚   â”‚  - /positions   â”‚
    â”‚ trades.jsonl â”‚   â”‚  - /history     â”‚
    â”‚ stats.json   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ state.json   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Dashboard   â”‚
    â”‚  (React App) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Quick Start

### 1. Set Your Auth Token

```bash
export LIMITLESS_AUTH_TOKEN="Bearer eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IlhIMTd4TjdyOTk3YTBKd1ZxNFVsZlh5TE9nOVRDZmFNR1l0OHB6MDJyMVEifQ..."
```

### 2. Deploy Everything

```bash
cd lambda
./deploy.sh
```

That's it! The Lambda will now run every 5 minutes and update your S3 bucket.

## What Gets Created

1. **IAM Role** (`limitless-lambda-role`)
   - Permissions to write to S3
   - Permissions to write CloudWatch logs

2. **Lambda Function** (`limitless-trade-generator`)
   - Runtime: Node.js 18
   - Memory: 256 MB
   - Timeout: 60 seconds
   - Runs every 5 minutes

3. **EventBridge Rule** (`limitless-trade-generator-schedule`)
   - Schedule: `rate(5 minutes)`
   - Triggers the Lambda automatically

4. **S3 Files** (generated by Lambda)
   - `s3://limitless-bot-logs/trades.jsonl`
   - `s3://limitless-bot-logs/stats.json`
   - `s3://limitless-bot-logs/state.json`

## Testing

### Test the Lambda

```bash
# Invoke manually
aws lambda invoke \
  --function-name limitless-trade-generator \
  --region us-east-1 \
  output.json

# View the output
cat output.json
```

Expected output:
```json
{
  "statusCode": 200,
  "body": "{\"message\":\"Trade files generated successfully\",\"trades\":25,\"positions\":3,\"stats\":{...}}"
}
```

### View Logs

```bash
# Tail logs in real-time
aws logs tail /aws/lambda/limitless-trade-generator --follow --region us-east-1
```

### Check S3 Files

```bash
# List files
aws s3 ls s3://limitless-bot-logs/

# Download and view
aws s3 cp s3://limitless-bot-logs/stats.json - | jq
aws s3 cp s3://limitless-bot-logs/trades.jsonl -
aws s3 cp s3://limitless-bot-logs/state.json - | jq
```

## Updating the Auth Token

Your auth token will expire periodically. Update it with:

```bash
aws lambda update-function-configuration \
  --function-name limitless-trade-generator \
  --environment Variables="{S3_BUCKET_NAME=limitless-bot-logs,LIMITLESS_AUTH_TOKEN=Bearer NEW_TOKEN_HERE}" \
  --region us-east-1
```

## Changing the Schedule

### Every 1 Minute (for active trading)
```bash
aws events put-rule \
  --name limitless-trade-generator-schedule \
  --schedule-expression "rate(1 minute)" \
  --region us-east-1
```

### Every 10 Minutes (less frequent)
```bash
aws events put-rule \
  --name limitless-trade-generator-schedule \
  --schedule-expression "rate(10 minutes)" \
  --region us-east-1
```

### Disable Schedule
```bash
aws events disable-rule \
  --name limitless-trade-generator-schedule \
  --region us-east-1
```

### Re-enable Schedule
```bash
aws events enable-rule \
  --name limitless-trade-generator-schedule \
  --region us-east-1
```

## Monitoring

### CloudWatch Dashboard

View in AWS Console:
1. Go to Lambda console
2. Click `limitless-trade-generator`
3. Click "Monitor" tab
4. View metrics: invocations, duration, errors

### Set Up Alerts

Create SNS topic for alerts:
```bash
aws sns create-topic --name limitless-lambda-alerts
aws sns subscribe \
  --topic-arn arn:aws:sns:us-east-1:YOUR_ACCOUNT:limitless-lambda-alerts \
  --protocol email \
  --notification-endpoint your@email.com
```

Create CloudWatch alarm for errors:
```bash
aws cloudwatch put-metric-alarm \
  --alarm-name limitless-lambda-errors \
  --alarm-description "Alert when Lambda has errors" \
  --metric-name Errors \
  --namespace AWS/Lambda \
  --statistic Sum \
  --period 300 \
  --threshold 1 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --dimensions Name=FunctionName,Value=limitless-trade-generator \
  --alarm-actions arn:aws:sns:us-east-1:YOUR_ACCOUNT:limitless-lambda-alerts
```

## Troubleshooting

### Issue: Lambda returns 500 error

**Check logs:**
```bash
aws logs tail /aws/lambda/limitless-trade-generator --region us-east-1
```

**Common causes:**
- Auth token expired â†’ Update token
- API endpoint changed â†’ Update code
- S3 permissions issue â†’ Check IAM role

### Issue: No files in S3

**Verify Lambda is running:**
```bash
# Check recent invocations
aws lambda get-function \
  --function-name limitless-trade-generator \
  --query 'Configuration' \
  --region us-east-1
```

**Check EventBridge rule:**
```bash
aws events describe-rule \
  --name limitless-trade-generator-schedule \
  --region us-east-1
```

**Manually invoke:**
```bash
aws lambda invoke \
  --function-name limitless-trade-generator \
  --region us-east-1 \
  output.json && cat output.json
```

### Issue: Dashboard shows old data

**Verify files are being updated:**
```bash
aws s3 ls s3://limitless-bot-logs/ --human-readable
```

**Check file contents:**
```bash
aws s3 cp s3://limitless-bot-logs/stats.json - | jq '.lastUpdated'
```

**Clear browser cache:**
- Dashboard caches S3 responses
- Hard refresh (Cmd+Shift+R or Ctrl+Shift+R)
- Or add cache-busting in dashboard

## Cleanup / Removal

To remove all Lambda resources:

```bash
# Delete EventBridge rule targets
aws events remove-targets \
  --rule limitless-trade-generator-schedule \
  --ids 1 \
  --region us-east-1

# Delete EventBridge rule
aws events delete-rule \
  --name limitless-trade-generator-schedule \
  --region us-east-1

# Delete Lambda function
aws lambda delete-function \
  --function-name limitless-trade-generator \
  --region us-east-1

# Delete IAM role policy
aws iam delete-role-policy \
  --role-name limitless-lambda-role \
  --policy-name limitless-s3-access

# Delete IAM role
aws iam delete-role \
  --role-name limitless-lambda-role
```

## Cost

Running every 5 minutes:
- **Invocations:** ~8,640/month (288/day)
- **Lambda cost:** ~$0.20/month
- **S3 cost:** ~$0.10/month
- **Logs cost:** ~$0.50/month

**Total: < $1/month**

## Next Steps

1. âœ… Lambda deployed and running
2. âœ… Files being generated in S3
3. ğŸ”² Deploy dashboard (see main README.md)
4. ğŸ”² Set up custom domain
5. ğŸ”² Add monitoring alerts
6. ğŸ”² Implement token rotation

## Support

For detailed Lambda documentation, see `lambda/README.md`

For dashboard setup, see main `README.md`

For full setup guide, see `SETUP.md`
